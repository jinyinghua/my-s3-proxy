<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Vercel S3 Manager</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .file-item { padding: 10px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>
    <h2>存储桶管理器 (Vercel 版)</h2>
    <input type="text" id="bucket" placeholder="输入存储桶名称">
    <button onclick="loadFiles()">查看文件</button>
    <hr>
    <input type="file" id="picker">
    <button onclick="uploadFile()">上传</button>
    <div id="list"></div>

    <script>
        async function loadFiles() {
            const bucket = document.getElementById('bucket').value;
            const res = await fetch(`/api/s3?action=list&bucket=${bucket}`);
            const data = await res.json();
            const listDiv = document.getElementById('list');
            listDiv.innerHTML = data.map(f => `<div class="file-item">${f.Key} (${(f.Size/1024).toFixed(1)} KB)</div>`).join('');
        }

        async function uploadFile() {
            const bucket = document.getElementById('bucket').value;
            const file = document.getElementById('picker').files[0];
            if(!file) return alert("选文件");

            // 1. 获取预签名上传地址 (由 Vercel 后端生成)
            const preRes = await fetch(`/api/s3?action=uploadUrl&bucket=${bucket}&fileName=${file.name}&fileType=${file.type}`);
            const { url } = await preRes.json();

            // 2. 直接通过该链接上传 (这种方式通常可以绕过 S3 的 CORS 限制)
            const upload = await fetch(url, {
                method: 'PUT',
                body: file,
                headers: { 'Content-Type': file.type }
            });

            if(upload.ok) { alert("上传成功"); loadFiles(); }
            else { alert("上传失败，可能依然存在服务端 CORS 限制，请尝试在浏览器安装 CORS 插件"); }
        }
    </script>
</body>
</html>
